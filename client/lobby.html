<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cube Dash Arena - Lobby</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #121212;
            color: #ffffff;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-image: linear-gradient(to bottom right, #1a1a2e, #16213e, #0f3460);
        }
        
        .container {
            background-color: rgba(0, 0, 0, 0.7);
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            width: 80%;
            max-width: 800px;
        }
        
        h1 {
            color: #ff2e63;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 0 0 10px rgba(255, 46, 99, 0.5);
        }
        
        .lobby-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .player-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        input[type="text"] {
            padding: 12px;
            border-radius: 5px;
            border: none;
            background-color: #2a2a3a;
            color: white;
            font-size: 16px;
        }
        
        button {
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            background-color: #ff2e63;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        button:hover {
            background-color: #ff5c8a;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 46, 99, 0.4);
        }
        
        .players-list {
            background-color: #1e1e30;
            border-radius: 5px;
            padding: 15px;
            margin-top: 20px;
        }
        
        .player-item {
            padding: 10px;
            margin: 5px 0;
            background-color: #2a2a3a;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
        }
        
        .player-ready {
            color: #4ecca3;
        }
        
        .player-waiting {
            color: #ffbd69;
        }
        
        .leaderboard {
            margin-top: 30px;
        }
        
        .leaderboard h2 {
            color: #4ecca3;
            text-align: center;
            margin-bottom: 15px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #333;
        }
        
        th {
            background-color: #1e1e30;
            color: #ff2e63;
        }
        
        tr:hover {
            background-color: #2a2a3a;
        }
        
        .status-message {
            text-align: center;
            margin: 20px 0;
            padding: 10px;
            border-radius: 5px;
            background-color: #1e1e30;
            color: #4ecca3;
        }
        
        .game-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }
        
        .start-button {
            background-color: #4ecca3;
        }
        
        .start-button:hover {
            background-color: #6edfc5;
            box-shadow: 0 5px 15px rgba(78, 204, 163, 0.4);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Cube Dash Arena</h1>
        
        <div class="lobby-section">
            <div class="player-form">
                <input type="text" id="playerName" placeholder="Enter your name" maxlength="15">
                <button id="joinButton">Join Game</button>
            </div>
            
            <div class="status-message" id="statusMessage">
                Waiting for players to join...
            </div>
            
            <div class="players-list">
                <h3>Players in Lobby</h3>
                <div id="playersList">
                    <!-- Players will be listed here dynamically -->
                </div>
            </div>
            
            <div class="game-controls">
                <button id="startButton" class="start-button" disabled>Start Game</button>
                <button id="readyButton" disabled>Ready</button>
            </div>
            
            <div class="leaderboard">
                <h2>Leaderboard</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Player</th>
                            <th>Score</th>
                            <th>Games</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboardBody">
                        <!-- Leaderboard entries will be added here dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script src="/socket.io/socket.io.js"></script>
    <script src="/sounds.js"></script>
    <script>
        // Connect to the server
        const socket = io();
        
        // DOM elements
        const playerNameInput = document.getElementById('playerName');
        const joinButton = document.getElementById('joinButton');
        const readyButton = document.getElementById('readyButton');
        const startButton = document.getElementById('startButton');
        const statusMessage = document.getElementById('statusMessage');
        const playersList = document.getElementById('playersList');
        const leaderboardBody = document.getElementById('leaderboardBody');
        
        // Player state
        let currentPlayer = {
            id: null,
            name: '',
            isReady: false,
            isHost: false
        };
        
        // Game state
        let players = [];
        let leaderboard = [];
        
        // Join the game
        joinButton.addEventListener('click', () => {
            const name = playerNameInput.value.trim();
            if (name) {
                socket.emit('joinLobby', { name });
                playerNameInput.disabled = true;
                joinButton.disabled = true;
                readyButton.disabled = false;
                statusMessage.textContent = 'Joining lobby...';
            } else {
                alert('Please enter your name');
            }
        });
        
        // Ready up
        readyButton.addEventListener('click', () => {
            currentPlayer.isReady = !currentPlayer.isReady;
            socket.emit('playerReady', { ready: currentPlayer.isReady });
            readyButton.textContent = currentPlayer.isReady ? 'Not Ready' : 'Ready';
            readyButton.style.backgroundColor = currentPlayer.isReady ? '#ff2e63' : '#4ecca3';
        });
        
        // Start the game (host only)
        startButton.addEventListener('click', () => {
            socket.emit('startGame');
        });
        
        // Socket events
        socket.on('connect', () => {
            currentPlayer.id = socket.id;
            console.log('Connected to server with ID:', currentPlayer.id);
        });
        
        socket.on('lobbyUpdate', (data) => {
            players = data.players;
            updatePlayersList();
            
            // Check if current player is host
            const isHost = players.length > 0 && players[0].id === currentPlayer.id;
            currentPlayer.isHost = isHost;
            
            // Enable start button if host and at least 2 players are ready
            const readyPlayers = players.filter(p => p.isReady).length;
            startButton.disabled = !(isHost && readyPlayers >= 1);
            
            // Update status message
            if (players.length < 2) {
                statusMessage.textContent = 'Waiting for more players to join...';
            } else if (readyPlayers < players.length) {
                statusMessage.textContent = 'Waiting for all players to be ready...';
            } else {
                statusMessage.textContent = 'All players ready! Game can start.';
            }
        });
        
        socket.on('playerJoined', (data) => {
            if (data.id === currentPlayer.id) {
                currentPlayer.name = data.name;
                statusMessage.textContent = 'You joined the lobby. Get ready!';
            } else {
                // Play sound when another player joins
                if (window.soundManager) {
                    window.soundManager.playPlayerJoinedSound();
                }
                statusMessage.textContent = `${data.name} joined the lobby!`;
            }
        });
        
        socket.on('leaderboardUpdate', (data) => {
            leaderboard = data;
            updateLeaderboard();
        });
        
        socket.on('gameStarting', () => {
            statusMessage.textContent = 'Game starting in 3 seconds...';
            
            // Play game starting sound
            if (window.soundManager) {
                window.soundManager.playGameStartingSound();
            }
            
            // Countdown with visual feedback
            let countdown = 3;
            statusMessage.textContent = `Game starting in ${countdown} seconds...`;
            
            const countdownInterval = setInterval(() => {
                countdown--;
                if (countdown > 0) {
                    statusMessage.textContent = `Game starting in ${countdown} seconds...`;
                } else {
                    clearInterval(countdownInterval);
                    statusMessage.textContent = 'Starting now!';
                    window.location.href = '/game.html?name=' + encodeURIComponent(currentPlayer.name);
                }
            }, 1000);
        });
        
        // Helper functions
        function updatePlayersList() {
            playersList.innerHTML = '';
            players.forEach(player => {
                const playerItem = document.createElement('div');
                playerItem.className = 'player-item';
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = player.name + (player.id === currentPlayer.id ? ' (You)' : '');
                
                const statusSpan = document.createElement('span');
                statusSpan.textContent = player.isReady ? 'Ready' : 'Not Ready';
                statusSpan.className = player.isReady ? 'player-ready' : 'player-waiting';
                
                playerItem.appendChild(nameSpan);
                playerItem.appendChild(statusSpan);
                playersList.appendChild(playerItem);
            });
        }
        
        function updateLeaderboard() {
            leaderboardBody.innerHTML = '';
            leaderboard.forEach((entry, index) => {
                const row = document.createElement('tr');
                
                const rankCell = document.createElement('td');
                rankCell.textContent = index + 1;
                
                const nameCell = document.createElement('td');
                nameCell.textContent = entry.name;
                
                const scoreCell = document.createElement('td');
                scoreCell.textContent = entry.highScore;
                
                const gamesCell = document.createElement('td');
                gamesCell.textContent = entry.games;
                
                row.appendChild(rankCell);
                row.appendChild(nameCell);
                row.appendChild(scoreCell);
                row.appendChild(gamesCell);
                
                leaderboardBody.appendChild(row);
            });
        }
    </script>
</body>
</html>
